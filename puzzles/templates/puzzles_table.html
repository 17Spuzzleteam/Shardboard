{% load puzzle_extras %}

<table class="table table-sm tree" id="puzzles" style="width:100%">
</table>

<script type="text/javascript">
var slack_base_url = '{{ slack_base_url }}';
var data = [
{% for p, tags, metas, active_users, status_form, puzzle_class in rows %}['{{p.pk}}', '{{p.name}}', '{{p.url}}', '{{p.is_meta}}', '{{active_users|join:", "}}', '{{p.answer}}', '{{p.status}}', '{{p.sheet}}', '{{p.channel}}', {{tags|safe}}, '', '{{puzzle_class}}', ],
{% endfor %}
];

$(document).ready(function() {
    // indices into data array
    var pk = 0,
        name = 1,
        url = 2,
        is_meta = 3,
        active_users = 4,
        answer = 5,
        status = 6,
        sheet = 7,
        channel = 8,
        tags = 9,
        metas = 10,
        puzzle_class = 11;

    var start_ts = Date.now();
    var pre_dt_init_ts = Date.now();

    var table = $('#puzzles').DataTable({
        'data': data,
        'paging': true,
        'pageLength': 50,
        'ordering': false,
        'createdRow': function(row, data, dataIndex) {
            $(row).addClass(data[puzzle_class]);
        },
        'columnDefs': [
            {
                'visible': false,
                'targets': [pk, url, is_meta, active_users, puzzle_class],
            },

            {'title': 'Name', 'targets': name},
            {'title': 'Answer', 'targets': answer},
            {'title': 'Status', 'targets': status},
            {'title': 'Sheet', 'targets': sheet},
            {'title': 'Slack', 'targets': channel},
            {'title': 'Tags', 'targets': tags},
            {'title': 'Metas', 'targets': metas},

            {'width': '30%', 'targets': name},
            {'width': '17.5%', 'targets': [answer, tags]},
            {'width': '80px', 'targets': metas},
            {'width': '60px', 'targets': [sheet, channel]},

            {
                'targets': name,
                'render': function(data, type, row, meta) {
                    if (type === 'display') {
                        data = '<a href="' + row[url] + '">' + row[name] + '</a>';
                        if (row[is_meta] === 'True') {
                            data += ' <span class="badge badge-dark badge-meta">META</span>';
                        }
                        if (row[active_users]) {
                            data += ` <span data-toggle="tooltip" title="${row[active_users]}">
                                          <i class="fa fa-users" aria-hidden="true"></i>
                                        </span>`;
                        }
                        data += `
    <button type="button" class="editpuzzle btn btn-default" data-toggle="modal" data-target="#editpuzzle" data-pk="${row[pk]}" data-name="${row[name]}" data-url="${row[url]}" data-is_meta="${row[is_meta]}" style="padding: 0px 0px;">
        <i class="fa fa-edit" aria-hidden="true"></i>
    </button>
    <button type="button" class="deletepuzzle btn btn-default" data-toggle="modal" data-target="#deletepuzzle" data-pk="${row[pk]}" data-name="${row[name]}" style="padding: 0px 0px;">
        <i class="fa fa-trash-o" aria-hidden="true"></i>
    </button>`;
                    }

                    return data;
                },
            },
            {
                'targets': answer,
                'render': function(data, type, row, meta) {
                    if (data) {
                        return data;
                    }
                    result = `
                    <button type="button" class="submitanswer btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#submitanswer" data-pk="${row[pk]}" data-name="${row[name]}">
                        Submit Answer
                    </button>`;
                    return result;
                }
            },
            {
                'targets': status,
                'render': function(data, type, row, meta) {
                    result = row[status];
                    if (row[status] !== 'PENDING' && row[status] !== 'SOLVED') {
                        result += `
<button type="button" class="editstatus btn btn-default" data-toggle="modal" data-target="#editstatus" data-pk="${row[pk]}" data-name="${row[name]}" data-status="${row[status]}" style="padding: 0px 0px;">
    <i class="fa fa-edit" aria-hidden="true"></i>
</button>`
                    }
                    return result;
                }
            },
            {
                'targets': sheet,
                'render': function(data, type, row, meta) {
                    result = '';
                    if (data) {
                        result = `<a href="${data}" target="_blank">Link</a>`;
                    }
                    return result;
                }
            },
            {
                'targets': channel,
                'render': function(data, type, row, meta) {
                    result = '';
                    if (data) {
                        result = `<a href="${slack_base_url}/app_redirect?channel=${data}" target="_blank">Link</a>`
                    }
                    return result;
                }
            },
            {
                'targets': tags,
                'render': function(data, type, row, meta) {
                    result = '';
                    for (var i = 0; i < data.length; i++) {
                        tag = data[i];
                        result += `
    <form method="post" action="/puzzles/remove_tag/${row[pk]}/${tag[0]}">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}">
        <small>
            <span class="badge badge-${tag[1]}">${tag[0]}</span>
            <button type="submit" class="btn btn-default" style="padding: 0px 0px;">
                <i class="fa fa-xs fa-times"></i>
            </button>
        </small>
    </form>`;
                    }
                    result += `
<button type="button" class="addtag btn btn-default" data-toggle="modal" data-target="#addtag" data-pk="${row[pk]}" style="padding: 0px 0px;">
    <i class="fa fa-xs fa-plus" aria-hidden="true"></i>
</button>`
                    return result;
                }
            },
            {
                'targets': metas,
                'render': function(data, type, row, meta) {
                    result = `
                    <button type="button" class="meta btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#meta" data-pk="${row[pk]}">
                        Assign Metas
                    </button>`;

                    return result;
                }
            }
        ],
    });

    var dt_init_ts = Date.now();
    var dt_init_ms = dt_init_ts - pre_dt_init_ts;
    console.log("Datatable init time (ms) :" + dt_init_ms);

    var all_uncollapsed = false;
    function maybeExpandAll() {
        if ( all_uncollapsed == false ) {
            all_uncollapsed = true;
            $('.tree').treegrid('expandAll');
        }
    }
    table.on( 'search.dt', maybeExpandAll);

    // Initialize treegrid.
    var pre_treegrid_ts = Date.now();
    function initTreegrid() {
        $('.tree').treegrid({
            onCollapse: function() {
                all_uncollapsed = false;
            }
        });
        if ($('.tree').hasClass( "initial-collapsed" )) {
            $('.initial-collapsed').treegrid('collapse');
        }
    }
    initTreegrid();
    // New datatable page and search should also trigger treegrid.
    $('#puzzles').on( "draw.dt", initTreegrid);

    var treegrid_ts = Date.now();
    var treegrid_ms = treegrid_ts - pre_treegrid_ts;
    var total_ms = treegrid_ts - start_ts;
    console.log("treegrid init time (ms): " + treegrid_ms);
    console.log("total time(ms): " + total_ms);
});
</script>

{% include "modals/edit_puzzle.html" %}
{% include "modals/delete_puzzle.html" %}
{% include "modals/submit_answer.html" %}
{% include "modals/edit_status.html" %}
{% include "modals/add_tag.html" %}
{% include "modals/set_meta.html" %}