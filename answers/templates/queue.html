{% extends "base.html" %}

{% block page_content %}

<div class="row justify-content-between" style="margin:10">
    <div class="col-10">
        <h1>{{ hunt_name }} - Answer Queue</h1>
    </div>
</div>

<div class="px-3 pb-3">
    <table class="table table-sm" id="queue" style="width:100%">
    </table>
</div>

<script type="text/javascript">
$(document).ready(function() {
    // table column indices
    let answer_class = 0,
        time = 1,
        puzzle_name = 2,
        puzzle_url = 3,
        puzzle_is_meta = 4,
        guess = 5,
        answer_status = 6,
        id = 7,
        notes = 8;

    let statuses = ['NEW', 'SUBMITTED', 'CORRECT', 'INCORRECT', 'PARTIAL',];

    let table = $('#queue').DataTable( {
        "ajax": "/answers/queue/{{hunt_pk}}/answers",
        "paging": true,
        "pageLength": 50,
        "info": true,
        "scrollX": true,
        "scrollY": true,
        "order": [[ time, "desc" ]],
        "ordering": false,
        "createdRow": function(row, data, dataIndex) {
            $(row).addClass(data[answer_class]);
        },
        "initComplete": function(settings, json) {
            initUpdateStatus(json['data'][0][id]);
        },
        "columnDefs": [
            {
                'visible': false,
                'targets': [answer_class, id, puzzle_url, puzzle_is_meta],
            },
            {
                'searchable': false,
                'targets': [answer_class, id, time, puzzle_url, puzzle_is_meta],
            },
            {'title': 'Time', 'targets': time},
            {'title': 'Puzzle', 'targets': puzzle_name},
            {'title': 'Answer', 'targets': guess},
            {'title': 'Status', 'targets': answer_status},
            {'title': 'Notes', 'targets': notes},

            {
                'targets': time,
                'render': function(data, type, row, meta) {
                    return moment(data).format('MMM D, YYYY, h:m a');
                },
            },
            {
                'targets': puzzle_name,
                'render': function(data, type, row, meta) {
                    let result = '<a href="' + row[puzzle_url] + '">' + row[puzzle_name] + '</a>';
                    if (row[puzzle_is_meta]) {
                        result += ' <span class="badge badge-dark badge-meta">META</span>';
                    }
                    return result;
                },
            },
            {
                'targets': guess,
                'render': function(data, type, row, meta) {
                    return `<p class="text-monospace">${data}</p>`
                },
            },
            {
                'targets': answer_status,
                'render': function(data, type, row, meta) {
                    let result = data;
                    if (type === 'display') {
                        result = `
        <div class="form-group">
            <select name="status" class="form-control form-control-sm" id="answer-status-${row[id]}" data-id="${row[id]}">
    `;
                        for (const status of statuses) {
                            result += '<option value="' + status + '"';
                            if (status === data) {
                                result += ' selected';
                            }
                            result += '>' + status + '</option>\n';
                        }

                        result += `
            </select>
        </div>`;
                    }
                    return result;
                },
            },
            {
                'targets': notes,
                'render': function(data, type, row, meta) {
                    let result = `
<form action="/answers/update_note/${row[id]}" method="post" class="form-inline">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="form-group">
        <input type="text" name="text" class="form-control form-control-sm col-xs-4" placeholder="Enter notes here" maxlength="128" required`;
                    if (data) {
                        result += ` value=${data}`;
                    }
                    result += `>
        <button type="submit" class="btn btn-outline-primary btn-sm">Submit</button>
    </div>
</form>`;
                    return result;
                },
            },
        ],
    } );

    function initUpdateStatus(maxId) {
        for (let i = 0; i <= maxId; i++) {
            $(`#answer-status-${i}`).change(function() {
                $.ajax('/answers/queue/{{hunt_pk}}/' + $(this).data('id'), {
                    'data': {
                        'csrfmiddlewaretoken': '{{csrf_token}}',
                        'status': $(this).val()
                    },
                    'method': 'POST',
                    'success': function(response) {
                        reload();
                    },
                    'error': function(response) {
                        console.log('Got error response when updating answer:', response);
                        reload();
                    }
                });
            });
        }
    }

    function reload() {
        table.ajax.reload(function(response) {
            // first element has max id
            initUpdateStatus(response['data'][0][id]);
        }, false /* resetPaging */);
    }

    setInterval(function() {
        reload();
    }, 10000);
});
</script>
{% endblock %}
